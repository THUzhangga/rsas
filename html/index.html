<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Documentation of the rsas library &mdash; rsas 0.1.1 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="rsas 0.1.1 documentation" href="#" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="#">rsas 0.1.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="documentation-of-the-rsas-library">
<h1>Documentation of the rsas library<a class="headerlink" href="#documentation-of-the-rsas-library" title="Permalink to this headline">¶</a></h1>
<p>This library allows you to model transport through arbitrary control volumes using
rank StorAge Selection (rSAS) functions.</p>
</div>
<div class="section" id="getting-started">
<h1>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h1>
<div class="section" id="before-you-install">
<h2>Before you install<a class="headerlink" href="#before-you-install" title="Permalink to this headline">¶</a></h2>
<p>rsas depends on the Python libraries numpy, scipy, and cython, and the example
codes use pandas to wrangle the timeseries data. These must all be installed.
The Anaconda package (<a class="reference external" href="https://store.continuum.io/cshop/anaconda/">https://store.continuum.io/cshop/anaconda/</a>) contains all
the needed pieces, and is an easy way to get started. Install it before you
install rsas.</p>
<p>Parts of rsas must be compiled with a C compiler. This generally happens seamlessly
on OSX and *nix if you follow the steps below. On Windows you may need to first
install Microsoft Visual C++ Compiler for Python 2.7 BEFORE you install Anaconda
Python.</p>
<p><a class="reference external" href="https://www.microsoft.com/en-us/download/details.aspx?id=44266">https://www.microsoft.com/en-us/download/details.aspx?id=44266</a></p>
</div>
<div class="section" id="getting-rsas">
<h2>Getting rsas<a class="headerlink" href="#getting-rsas" title="Permalink to this headline">¶</a></h2>
<p>rsas is available from github: <a class="reference external" href="https://github.com/charman2/rsas">https://github.com/charman2/rsas</a></p>
<p>The code is still very much in beta. USE AT YOUR OWN RISK. I make no assurances.</p>
<p>The code can be downloaded zipped, but a git clone is recommended so updates
can be provided as they are developed.</p>
</div>
<div class="section" id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>The main part of the code is written in Cython to allow fast execution. Before
you use rsas you must comile and install it. Open a terminal in the rsas directory
and run:</p>
<p>&gt; python setup.py install</p>
<p>It may take a few minutes. You may get warning messages, all of which can be ignored.
Error messages cannot though, and will prevent the compilation from completion.</p>
<p>If you are getting strange messages about <cite>vcvarsall.bat</cite> you may need to install
the MS Visual C++ compiler (see above) and then re-install Anaconda Python.</p>
<p>Once the code has compiled successfully you don&#8217;t need to do it again
unless this code is changed.</p>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>Example uses of rsas are available in the ./examples directory. These should
run right out of the box.</p>
<div class="section" id="steady-py">
<h3>steady.py<a class="headerlink" href="#steady-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Storage selection (SAS) functions: example with one flux out at steady state</span>

<span class="sd">Runs the rSAS model for a synthetic dataset with one flux in and out</span>
<span class="sd">and steady state flow</span>

<span class="sd">Theory is presented in:</span>
<span class="sd">Harman, C. J. (2014), Time-variable transit time distributions and transport:</span>
<span class="sd">Theory and application to storage-dependent transport of chloride in a watershed,</span>
<span class="sd">Water Resour. Res., 51, doi:10.1002/2014WR015707.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">rsas</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="c"># =====================================</span>
<span class="c"># Generate the input timeseries</span>
<span class="c"># =====================================</span>
<span class="c"># length of the dataset</span>
<span class="n">S_0</span> <span class="o">=</span> <span class="mf">4.</span> <span class="c"># &lt;-- volume of the uniformly sampled store</span>
<span class="n">Q_0</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c"># &lt;-- steady-state flow rate</span>
<span class="n">T_0</span> <span class="o">=</span> <span class="n">S_0</span> <span class="o">/</span> <span class="n">Q_0</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">n_substeps</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c"># Steady-state flow in and out for N timesteps</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">Q_0</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">Q_0</span>
<span class="c"># A timeseries of concentrations</span>
<span class="n">C_J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="c">#C_J = -np.log(np.random.rand(N,1))</span>
<span class="c"># =========================</span>
<span class="c"># Parameters needed by rsas</span>
<span class="c"># =========================</span>
<span class="c"># The concentration of water older than the start of observations</span>
<span class="n">C_old</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="c"># =========================</span>
<span class="c"># Create the rsas functions</span>
<span class="c"># =========================</span>
<span class="c"># Parameters for the rSAS function</span>
<span class="c"># The uniform distribution extends between S_T=a and S_T=b.</span>
<span class="n">Q_rSAS_fun_type</span> <span class="o">=</span> <span class="s">&#39;uniform&#39;</span>
<span class="n">ST_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span>
<span class="n">ST_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">S_0</span>
<span class="n">Q_rSAS_fun_parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">ST_min</span><span class="p">,</span> <span class="n">ST_max</span><span class="p">]</span>
<span class="n">rSAS_fun_Q1</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="n">Q_rSAS_fun_type</span><span class="p">,</span> <span class="n">Q_rSAS_fun_parameters</span><span class="p">)</span>
<span class="c"># =================</span>
<span class="c"># Initial condition</span>
<span class="c"># =================</span>
<span class="c"># Unknown initial age distribution, so just set this to zeros</span>
<span class="n">ST_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="c"># =============</span>
<span class="c"># Run the model - first method</span>
<span class="c"># =============</span>
<span class="c"># Run it</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="p">[</span><span class="n">rSAS_fun_Q1</span><span class="p">],</span> <span class="n">ST_init</span><span class="o">=</span><span class="n">ST_init</span><span class="p">,</span>
                     <span class="n">mode</span><span class="o">=</span><span class="s">&#39;RK4&#39;</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">n_substeps</span><span class="o">=</span><span class="n">n_substeps</span><span class="p">,</span> <span class="n">C_J</span><span class="o">=</span><span class="n">C_J</span><span class="p">,</span> <span class="n">C_old</span><span class="o">=</span><span class="p">[</span><span class="n">C_old</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c">#%%</span>
<span class="c"># Timestep-averaged outflow concentration</span>
<span class="c"># ROWS of C_Q are t - times</span>
<span class="c"># COLUMNS of PQ are q - fluxes</span>
<span class="n">C_Qm1</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;C_Q&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="c"># =============</span>
<span class="c"># Run the model - second method</span>
<span class="c"># =============</span>
<span class="c"># Run it</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="p">[</span><span class="n">rSAS_fun_Q1</span><span class="p">],</span> <span class="n">ST_init</span><span class="o">=</span><span class="n">ST_init</span><span class="p">,</span>
                     <span class="n">mode</span><span class="o">=</span><span class="s">&#39;RK4&#39;</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">n_substeps</span><span class="o">=</span><span class="n">n_substeps</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c"># Age-ranked storage</span>
<span class="c"># ROWS of ST are T - ages</span>
<span class="c"># COLUMNS of ST are t - times</span>
<span class="c"># LAYERS of MS are s - solutes</span>
<span class="n">ST</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;ST&#39;</span><span class="p">]</span>
<span class="c"># Timestep-averaged backwards TTD</span>
<span class="c"># ROWS of PQ are T - ages</span>
<span class="c"># COLUMNS of PQ are t - times</span>
<span class="c"># LAYERS of PQ are q - fluxes</span>
<span class="n">PQm</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;PQ&#39;</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">]</span>
<span class="c"># Timestep-averaged outflow concentration</span>
<span class="c"># ROWS of C_Q are t - times</span>
<span class="c"># COLUMNS of PQ are q - fluxes</span>
<span class="c"># Use rsas.transport to convolve the input concentration with the TTD</span>
<span class="n">C_Qm2</span><span class="p">,</span> <span class="n">C_mod_raw</span><span class="p">,</span> <span class="n">observed_fraction</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">transport</span><span class="p">(</span><span class="n">PQm</span><span class="p">,</span> <span class="n">C_J</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">C_old</span><span class="p">)</span>
<span class="c"># ==================================</span>
<span class="c"># Plot the age-ranked storage</span>
<span class="c"># ==================================</span>
<span class="k">print</span> <span class="s">&#39;Plotting ST at the last timestep&#39;</span>
<span class="c"># The analytical solution for the age-ranked storage is</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ST_exact</span> <span class="o">=</span> <span class="n">S_0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">/</span><span class="n">T_0</span><span class="p">))</span>
<span class="c"># plot this with the rsas estimate</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ST</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;rsas model&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ST_exact</span><span class="p">,</span> <span class="s">&#39;r-.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;analytical solution&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">S_0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;$S_T(T)$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;age $T$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Age-ranked storage&#39;</span><span class="p">)</span>
<span class="c">#%%</span>
<span class="c"># =====================================================================</span>
<span class="c"># Outflow concentration estimated using several different TTD</span>
<span class="c"># =====================================================================</span>
<span class="c"># Lets get the instantaneous value of the TTD at the end of each timestep</span>
<span class="k">print</span> <span class="s">&#39;Getting the instantaneous TTD&#39;</span>
<span class="n">PQi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="n">PQi</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">rSAS_fun_Q1</span><span class="o">.</span><span class="n">cdf_i</span><span class="p">(</span><span class="n">ST</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
<span class="n">PQi</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[[</span><span class="n">rSAS_fun_Q1</span><span class="o">.</span><span class="n">cdf_i</span><span class="p">(</span><span class="n">ST</span><span class="p">[:,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]]</span><span class="o">.</span><span class="n">T</span>
<span class="c"># Lets also get the exact TTD</span>
<span class="k">print</span> <span class="s">&#39;Getting the exact solution&#39;</span>
<span class="n">n</span><span class="o">=</span><span class="mi">100</span>
<span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
<span class="n">PQe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">/</span><span class="n">T_0</span><span class="p">),</span> <span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
<span class="c"># Use the transit time distribution and input timeseries to estimate</span>
<span class="c"># the output timeseries for the exact and instantaneous cases</span>
<span class="k">print</span> <span class="s">&#39;Getting the concentrations&#39;</span>
<span class="n">C_Qi</span><span class="p">,</span> <span class="n">C_mod_raw</span><span class="p">,</span> <span class="n">observed_fraction</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">transport</span><span class="p">(</span><span class="n">PQi</span><span class="p">,</span> <span class="n">C_J</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">C_old</span><span class="p">)</span>
<span class="n">C_Qei</span><span class="p">,</span> <span class="n">C_mod_raw</span><span class="p">,</span> <span class="n">observed_fraction</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">transport</span><span class="p">(</span><span class="n">PQe</span><span class="p">,</span> <span class="n">C_J</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">C_old</span><span class="p">)</span>
<span class="c"># This calculates an exact timestep-averaged value</span>
<span class="n">C_Qem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">C_Qei</span><span class="p">,(</span><span class="n">N</span><span class="p">,</span><span class="n">n</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c"># Plot the results</span>
<span class="k">print</span> <span class="s">&#39;Plotting concentrations&#39;</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">C_Qem</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mean exact&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">C_Qm1</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mean rsas internal&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">C_Qm2</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mean rsas.transport&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="n">C_Qei</span><span class="p">,</span> <span class="s">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;inst. exact&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">C_Qi</span><span class="p">,</span> <span class="s">&#39;b:o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;inst. rsas.transport&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Concentration [-]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Outflow concentration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="steady2-py">
<h3>steady2.py<a class="headerlink" href="#steady2-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Storage selection (SAS) functions: example with multiple fluxes out at steady state</span>

<span class="sd">Runs the rSAS model for a synthetic dataset with one flux in and</span>
<span class="sd">multiple fluxes out and steady state flow</span>

<span class="sd">Theory is presented in:</span>
<span class="sd">Harman, C. J. (2014), Time-variable transit time distributions and transport:</span>
<span class="sd">Theory and application to storage-dependent transport of chloride in a watershed,</span>
<span class="sd">Water Resour. Res., 51, doi:10.1002/2014WR015707.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">rsas</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="c"># Initializes the random number generator so we always get the same result</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c"># =====================================</span>
<span class="c"># Generate the input timeseries</span>
<span class="c"># =====================================</span>
<span class="c"># length of the dataset</span>
<span class="n">S_0</span> <span class="o">=</span> <span class="mf">3.</span> <span class="c"># &lt;-- volume of the uniformly sampled store</span>
<span class="n">Q1_0</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c"># &lt;-- steady-state flow rate</span>
<span class="n">Q2_0</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c"># &lt;-- steady-state flow rate</span>
<span class="n">T_0</span> <span class="o">=</span> <span class="n">S_0</span> <span class="o">/</span> <span class="p">(</span><span class="n">Q1_0</span> <span class="o">+</span> <span class="n">Q2_0</span><span class="p">)</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">n_substeps</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c"># Steady-state flow in and out for N timesteps</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q1_0</span> <span class="o">+</span> <span class="n">Q2_0</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">Q1_0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">Q2_0</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span>
<span class="c"># A random timeseries of concentrations</span>
<span class="n">C_J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="c">#C_J = -np.log(np.random.rand(N,1))</span>
<span class="c"># =========================</span>
<span class="c"># Parameters needed by rsas</span>
<span class="c"># =========================</span>
<span class="c"># The concentration of water older than the start of observations</span>
<span class="n">C_old</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="c"># =========================</span>
<span class="c"># Create the rsas functions</span>
<span class="c"># =========================</span>
<span class="c"># Parameters for the rSAS function</span>
<span class="c"># The uniform distribution extends between S_T=a and S_T=b.</span>
<span class="n">Q_rSAS_fun_type</span> <span class="o">=</span> <span class="s">&#39;uniform&#39;</span>
<span class="n">ST_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span>
<span class="n">ST_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">S_0</span>
<span class="n">Q_rSAS_fun_parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">ST_min</span><span class="p">,</span> <span class="n">ST_max</span><span class="p">]</span>
<span class="n">rSAS_fun_Q1</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="n">Q_rSAS_fun_type</span><span class="p">,</span> <span class="n">Q_rSAS_fun_parameters</span><span class="p">)</span>
<span class="n">Q_rSAS_fun_type</span> <span class="o">=</span> <span class="s">&#39;uniform&#39;</span>
<span class="n">ST_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.</span>
<span class="n">ST_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">S_0</span>
<span class="n">Q_rSAS_fun_parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">ST_min</span><span class="p">,</span> <span class="n">ST_max</span><span class="p">]</span>
<span class="n">rSAS_fun_Q2</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="n">Q_rSAS_fun_type</span><span class="p">,</span> <span class="n">Q_rSAS_fun_parameters</span><span class="p">)</span>
<span class="n">rSAS_fun</span> <span class="o">=</span> <span class="p">[</span><span class="n">rSAS_fun_Q1</span><span class="p">,</span> <span class="n">rSAS_fun_Q2</span><span class="p">]</span>
<span class="c"># =================</span>
<span class="c"># Initial condition</span>
<span class="c"># =================</span>
<span class="c"># Unknown initial age distribution, so just set this to zeros</span>
<span class="n">ST_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="c"># =============</span>
<span class="c"># Run the model</span>
<span class="c"># =============</span>
<span class="c"># Run it</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">rSAS_fun</span><span class="p">,</span> <span class="n">ST_init</span><span class="o">=</span><span class="n">ST_init</span><span class="p">,</span>
                     <span class="n">mode</span><span class="o">=</span><span class="s">&#39;RK4&#39;</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">n_substeps</span><span class="o">=</span><span class="n">n_substeps</span><span class="p">,</span> <span class="n">C_J</span><span class="o">=</span><span class="n">C_J</span><span class="p">,</span> <span class="n">C_old</span><span class="o">=</span><span class="p">[</span><span class="n">C_old</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c"># Let&#39;s pull these out to make the outputs from rsas crystal clear</span>
<span class="c"># State variables: age-ranked storage of water and solutes</span>
<span class="c"># ROWS of ST, MS are T - ages</span>
<span class="c"># COLUMNS of ST, MS are t - times</span>
<span class="c"># LAYERS of MS are s - solutes</span>
<span class="n">ST</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;ST&#39;</span><span class="p">]</span>
<span class="n">MS</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;MS&#39;</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">]</span>
<span class="c"># Timestep-averaged backwards TTD</span>
<span class="c"># ROWS of PQ are T - ages</span>
<span class="c"># COLUMNS of PQ are t - times</span>
<span class="c"># LAYERS of PQ are q - fluxes</span>
<span class="n">PQ1m</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;PQ&#39;</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">PQ2m</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;PQ&#39;</span><span class="p">][:,:,</span><span class="mi">1</span><span class="p">]</span>
<span class="c"># Timestep-averaged outflow concentration</span>
<span class="c"># ROWS of C_Q are t - times</span>
<span class="c"># COLUMNS of C_Q are q - fluxes</span>
<span class="n">C_Q1m1</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;C_Q&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">C_Q2m1</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;C_Q&#39;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="c"># Timestep averaged solute load out</span>
<span class="c"># ROWS of MQ are T - ages</span>
<span class="c"># COLUMNS of MQ are t - times</span>
<span class="c"># LAYERS of MQ are q - fluxes</span>
<span class="c"># Last dimension of MQ are s - solutes</span>
<span class="n">MQ1m</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;MQ&#39;</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">MQ2m</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;MQ&#39;</span><span class="p">][:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="c">#%%</span>
<span class="c"># ==================================</span>
<span class="c"># Plot the age-ranked storage</span>
<span class="c"># ==================================</span>
<span class="c"># The analytical solution for the age-ranked storage is</span>
<span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ST_exact</span> <span class="o">=</span> <span class="n">S_0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">/</span><span class="n">T_0</span><span class="p">))</span>
<span class="c"># plot this with the rsas estimate</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ST</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;rsas model&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ST_exact</span><span class="p">,</span> <span class="s">&#39;r-.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;analytical solution&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">S_0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;$S_T(T)$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;age $T$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Age-ranked storage&#39;</span><span class="p">)</span>
<span class="c">#%%</span>
<span class="c"># =====================================================================</span>
<span class="c"># Outflow concentration estimated using several different TTD</span>
<span class="c"># =====================================================================</span>
<span class="c"># Lets get the instantaneous value of the TTD at the end of each timestep</span>
<span class="n">PQ1i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="n">PQ1i</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">rSAS_fun_Q1</span><span class="o">.</span><span class="n">cdf_i</span><span class="p">(</span><span class="n">ST</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
<span class="n">PQ1i</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[[</span><span class="n">rSAS_fun_Q1</span><span class="o">.</span><span class="n">cdf_i</span><span class="p">(</span><span class="n">ST</span><span class="p">[:,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]]</span><span class="o">.</span><span class="n">T</span>
<span class="c"># Lets also get the exact TTD for the combined flux out</span>
<span class="n">n</span><span class="o">=</span><span class="mi">100</span>
<span class="n">T</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
<span class="n">PQ1e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">T</span><span class="o">/</span><span class="n">T_0</span><span class="p">),</span> <span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
<span class="c"># Use the transit time distribution and input timeseries to estimate</span>
<span class="c"># the output timeseries for the exact, instantaneous and timestep-averaged cases</span>
<span class="n">C_Q1m2</span><span class="p">,</span> <span class="n">C_mod_raw</span><span class="p">,</span> <span class="n">observed_fraction</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">transport</span><span class="p">(</span><span class="n">PQ1m</span><span class="p">,</span> <span class="n">C_J</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">C_old</span><span class="p">)</span>
<span class="n">C_Q1i</span><span class="p">,</span> <span class="n">C_mod_raw</span><span class="p">,</span> <span class="n">observed_fraction</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">transport</span><span class="p">(</span><span class="n">PQ1i</span><span class="p">,</span> <span class="n">C_J</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">C_old</span><span class="p">)</span>
<span class="n">C_Q1ei</span><span class="p">,</span> <span class="n">C_mod_raw</span><span class="p">,</span> <span class="n">observed_fraction</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">transport</span><span class="p">(</span><span class="n">PQ1e</span><span class="p">,</span> <span class="n">C_J</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">C_old</span><span class="p">)</span>
<span class="c"># This calculates an exact timestep-averaged value</span>
<span class="n">C_Q1em</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">C_Q1ei</span><span class="p">,(</span><span class="n">N</span><span class="p">,</span><span class="n">n</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c"># Plot the results</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">C_Q1em</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mean exact&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">C_Q1m1</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mean rsas internal&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">C_Q1m2</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mean rsas.transport&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="n">C_Q1ei</span><span class="p">,</span> <span class="s">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;inst. exact&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">C_Q1i</span><span class="p">,</span> <span class="s">&#39;b:o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;inst. rsas.transport&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Concentration [-]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Outflow concentration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="unsteady-py">
<h3>unsteady.py<a class="headerlink" href="#unsteady-py" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Storage selection (SAS) functions: example with multiple fluxes out at steady state</span>

<span class="sd">Runs the rSAS model for a synthetic dataset with one flux in and</span>
<span class="sd">multiple fluxes out and steady state flow</span>

<span class="sd">Theory is presented in:</span>
<span class="sd">Harman, C. J. (2014), Time-variable transit time distributions and transport:</span>
<span class="sd">Theory and application to storage-dependent transport of chloride in a watershed,</span>
<span class="sd">Water Resour. Res., 51, doi:10.1002/2014WR015707.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">rsas</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="c"># Initializes the random number generator so we always get the same result</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="c"># =====================================</span>
<span class="c"># Load the input data</span>
<span class="c"># =====================================</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">&#39;Q1.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="c"># length of the dataset</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="c"># The individual timeseries can be pulled out of the dataframe</span>
<span class="n">S</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;S&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">J</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;J&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;Q1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">C_J</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;C_J&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">-</span><span class="mi">2</span>
<span class="n">C_Q1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;C_Q1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">ST_min</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;ST_min&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">ST_max</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;ST_max&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="c"># =========================</span>
<span class="c"># Parameters needed by rsas</span>
<span class="c"># =========================</span>
<span class="c"># The concentration of water older than the start of observations</span>
<span class="n">C_old</span> <span class="o">=</span> <span class="p">((</span><span class="n">J</span><span class="o">*</span><span class="n">C_J</span><span class="p">)[</span><span class="n">J</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">((</span><span class="n">J</span><span class="p">)[</span><span class="n">J</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="c"># =========================</span>
<span class="c"># Create the rsas functions</span>
<span class="c"># =========================</span>
<span class="n">S_dead</span> <span class="o">=</span> <span class="mf">10.</span>
<span class="c">#lam = 0.</span>
<span class="c"># Uniform</span>
<span class="c"># Parameters for the rSAS function</span>
<span class="n">Q_rSAS_fun_type</span> <span class="o">=</span> <span class="s">&#39;uniform&#39;</span>
<span class="n">ST_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<span class="n">ST_max</span> <span class="o">=</span> <span class="n">S</span> <span class="o">+</span> <span class="n">S_dead</span>
<span class="n">Q_rSAS_fun_parameters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">ST_min</span><span class="p">,</span> <span class="n">ST_max</span><span class="p">]</span>
<span class="n">rSAS_fun_Q1</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="n">Q_rSAS_fun_type</span><span class="p">,</span> <span class="n">Q_rSAS_fun_parameters</span><span class="p">)</span>
<span class="n">rSAS_fun</span> <span class="o">=</span> <span class="p">[</span><span class="n">rSAS_fun_Q1</span><span class="p">]</span>
<span class="c"># Kumaraswami</span>
<span class="c">## Parameters for the rSAS function</span>
<span class="c">#Q_rSAS_fun_type = &#39;kumaraswami&#39;</span>
<span class="c">#ST_min = np.ones(N) * 0.</span>
<span class="c">#ST_max = S + S_dead</span>
<span class="c">#a = np.maximum(0.01, 2. +  lam * (S - S.mean())/S.std())</span>
<span class="c">#b = np.ones(N) * 5.</span>
<span class="c">#Q_rSAS_fun_parameters = np.c_[a, b, ST_min, ST_max]</span>
<span class="c">#rSAS_fun_Q1 = rsas.create_function(Q_rSAS_fun_type, Q_rSAS_fun_parameters)</span>
<span class="c">#rSAS_fun = [rSAS_fun_Q1]</span>
<span class="c"># =================</span>
<span class="c"># Initial condition</span>
<span class="c"># =================</span>
<span class="c"># Unknown initial age distribution, so just set this to zeros</span>
<span class="n">ST_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="c"># =============</span>
<span class="c"># Run the model</span>
<span class="c"># =============</span>
<span class="c"># Run it</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">rSAS_fun</span><span class="p">,</span> <span class="n">ST_init</span><span class="o">=</span><span class="n">ST_init</span><span class="p">,</span>
                     <span class="n">mode</span><span class="o">=</span><span class="s">&#39;RK4&#39;</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">n_substeps</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">C_J</span><span class="o">=</span><span class="n">C_J</span><span class="p">,</span> <span class="n">C_old</span><span class="o">=</span><span class="p">[</span><span class="n">C_old</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c"># Let&#39;s pull these out to make the outputs from rsas crystal clear</span>
<span class="c"># State variables: age-ranked storage of water and solutes</span>
<span class="c"># ROWS of ST, MS are T - ages</span>
<span class="c"># COLUMNS of ST, MS are t - times</span>
<span class="c"># LAYERS of MS are s - solutes</span>
<span class="n">ST</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;ST&#39;</span><span class="p">]</span>
<span class="n">MS</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;MS&#39;</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">]</span>
<span class="c"># Timestep-averaged backwards TTD</span>
<span class="c"># ROWS of PQ are T - ages</span>
<span class="c"># COLUMNS of PQ are t - times</span>
<span class="c"># LAYERS of PQ are q - fluxes</span>
<span class="n">PQ1m</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;PQ&#39;</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">]</span>
<span class="c"># Timestep-averaged outflow concentration</span>
<span class="c"># ROWS of C_Q are t - times</span>
<span class="c"># COLUMNS of PQ are q - fluxes</span>
<span class="n">C_Q1m1</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;C_Q&#39;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="c"># Timestep averaged solute load out</span>
<span class="c"># ROWS of MQ are T - ages</span>
<span class="c"># COLUMNS of MQ are t - times</span>
<span class="c"># LAYERS of MQ are q - fluxes</span>
<span class="c"># Last dimension of MS are s - solutes</span>
<span class="n">MQ1m</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">&#39;MQ&#39;</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="c">#%%</span>
<span class="c"># ==================================</span>
<span class="c"># Plot the rSAS function</span>
<span class="c"># ==================================</span>
<span class="n">STx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">S</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">S_dead</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">Omega</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[[</span><span class="n">rSAS_fun_Q1</span><span class="o">.</span><span class="n">cdf_i</span><span class="p">(</span><span class="n">STx</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]]</span><span class="o">.</span><span class="n">T</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="kn">as</span> <span class="nn">cm</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">STx</span><span class="p">,</span> <span class="n">Omega</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">((</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">S</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">/</span><span class="n">S</span><span class="o">.</span><span class="n">ptp</span><span class="p">()))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;$\Omega_Q(T)$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;age-ranked storage $S_T$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Cumulative rSAS function&#39;</span><span class="p">)</span>
<span class="c">#%%</span>
<span class="c"># ==================================</span>
<span class="c"># Plot the transit time distribution</span>
<span class="c"># ==================================</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">PQ1m</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;$P_Q(T)$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;age $T$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Cumulative transit time distribution&#39;</span><span class="p">)</span>
<span class="c">#%%</span>
<span class="c"># =====================================================================</span>
<span class="c"># Outflow concentration estimated using several different TTD</span>
<span class="c"># =====================================================================</span>
<span class="c"># Lets get the instantaneous value of the TTD at the end of each timestep</span>
<span class="n">PQ1i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<span class="n">PQ1i</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">rSAS_fun_Q1</span><span class="o">.</span><span class="n">cdf_i</span><span class="p">(</span><span class="n">ST</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span>
<span class="n">PQ1i</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[[</span><span class="n">rSAS_fun_Q1</span><span class="o">.</span><span class="n">cdf_i</span><span class="p">(</span><span class="n">ST</span><span class="p">[:,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]]</span><span class="o">.</span><span class="n">T</span>
<span class="c"># Use the transit time distribution and input timeseries to estimate</span>
<span class="c"># the output timeseries for the instantaneous and timestep-averaged cases</span>
<span class="n">C_Q1i</span><span class="p">,</span> <span class="n">C_Q1i_raw</span><span class="p">,</span> <span class="n">Q1i_observed_fraction</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">transport</span><span class="p">(</span><span class="n">PQ1i</span><span class="p">,</span> <span class="n">C_J</span><span class="p">,</span> <span class="n">C_old</span><span class="p">)</span>
<span class="n">C_Q1m2</span><span class="p">,</span> <span class="n">C_Q1m2_raw</span><span class="p">,</span> <span class="n">Q1m2_observed_fraction</span> <span class="o">=</span> <span class="n">rsas</span><span class="o">.</span><span class="n">transport</span><span class="p">(</span><span class="n">PQ1m</span><span class="p">,</span> <span class="n">C_J</span><span class="p">,</span> <span class="n">C_old</span><span class="p">)</span>
<span class="c"># Plot the results</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">],</span> <span class="n">C_Q1m1</span><span class="p">,</span> <span class="s">&#39;g&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mean rsas internal&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">],</span> <span class="n">C_Q1m2</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mean rsas.transport&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">],</span> <span class="n">C_Q1m2_raw</span><span class="p">,</span> <span class="s">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;mean rsas.transport (obs part)&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s">&#39;post&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;datetime&#39;</span><span class="p">],</span> <span class="n">C_Q1i</span><span class="p">,</span> <span class="s">&#39;b:o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&#39;inst. rsas.transport&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c">#plt.plot(data[&#39;datetime&#39;], data[&#39;C_Q1&#39;], &#39;r.&#39;, label=&#39;observed&#39;, lw=2)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">&#39;Concentration [-]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">&#39;time&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;Outflow concentration&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="further-reading">
<h1>Further reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h1>
<p>The rSAS theory is described in:</p>
<p>Harman, C. J. (2014), Time-variable transit time distributions and transport:
Theory and application to storage-dependent transport of chloride in a watershed,
Water Resour. Res., 51, doi:10.1002/2014WR015707.</p>
<p>More information may be available at: <a class="reference external" href="http://landscapehydrology.com/rsas/">http://landscapehydrology.com/rsas/</a></p>
<div class="section" id="module-rsas">
<span id="documentation-for-the-code"></span><h2>Documentation for the code<a class="headerlink" href="#module-rsas" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="rsas.solve">
<code class="descclassname">rsas.</code><code class="descname">solve</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#rsas.solve" title="Permalink to this definition">¶</a></dt>
<dd><p>Solve the rSAS model for given fluxes</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><dl class="first last docutils">
<dt>J <span class="classifier-delimiter">:</span> <span class="classifier">n x 1 float64 ndarray</span></dt>
<dd>Timestep-averaged inflow timeseries for n timesteps</dd>
<dt>Q <span class="classifier-delimiter">:</span> <span class="classifier">n x q float64 ndarray or list of length n 1D float64 ndarray</span></dt>
<dd>Timestep-averaged outflow timeseries for n timesteps and q outflow fluxes.
Must have same units and length as J.  For multiple outflows, each column
represents one outflow</dd>
<dt>rSAS_fun <span class="classifier-delimiter">:</span> <span class="classifier">rSASFunctionClass or list of rSASFunctionClass generated by rsas.create_function</span></dt>
<dd>The number of rSASFunctionClass in this list must be the same as the
number of columns in Q if Q is an ndarray, or elements in Q if it is a list.</dd>
</dl>
</dd>
<dt>Kwargs:</dt>
<dd><dl class="first last docutils">
<dt>ST_init <span class="classifier-delimiter">:</span> <span class="classifier">m+1 x 1 float64 ndarray</span></dt>
<dd>Initial condition for the age-ranked storage. The length of ST_init
determines the maximum age calculated. The first entry must be 0
(corresponding to zero age). To calculate transit time dsitributions up
to m timesteps in age, ST_init should have length m + 1. The default
initial condition is ST_init=np.zeros(len(J) + 1).</dd>
<dt>dt <span class="classifier-delimiter">:</span> <span class="classifier">float (default 1)</span></dt>
<dd>Timestep, assuming same units as J</dd>
<dt>n_substeps <span class="classifier-delimiter">:</span> <span class="classifier">int (default 1)</span></dt>
<dd>If n_substeps&gt;1, the timesteps are subdivided to allow a more accurate
solution.</dd>
<dt>full_outputs <span class="classifier-delimiter">:</span> <span class="classifier">bool (default True)</span></dt>
<dd>Option to return the full state variables array ST the cumulative
transit time distributions PQ, and other variables</dd>
<dt>verbose <span class="classifier-delimiter">:</span> <span class="classifier">bool (default False)</span></dt>
<dd>Print information about the progression of the model</dd>
<dt>debug <span class="classifier-delimiter">:</span> <span class="classifier">bool (default False)</span></dt>
<dd>Print information ever substep</dd>
<dt>C_J <span class="classifier-delimiter">:</span> <span class="classifier">n x s float64 ndarray (default None)</span></dt>
<dd>Optional timeseries of inflow concentrations for s solutes</dd>
<dt>CS_init <span class="classifier-delimiter">:</span> <span class="classifier">s X 1 or m+1 x s float64 ndarray</span></dt>
<dd>Initial condition for calculating the age-ranked solute mass. Must be a 2-D
array the same length as ST_init or a 1-D array, where the concentration in
storage is assumed to be constant for all ages.</dd>
<dt>C_old <span class="classifier-delimiter">:</span> <span class="classifier">s x 1 float64 ndarray (default None)</span></dt>
<dd>Optional concentration of the &#8216;unobserved fraction&#8217; of Q (from inflows
prior to the start of the simulation) for correcting C_Q. If ST_init is
not given or set to all zeros, the unobserved fraction will be assumed 
for water that entered prior to time zero (diagonal of the PQ matrix).
Otherwise it will be used for water older than the oldest water in ST 
(the bottom row of the PQ matrix).</dd>
<dt>alpha <span class="classifier-delimiter">:</span> <span class="classifier">n x q x s or q x s float64 ndarray</span></dt>
<dd>Optional partitioning coefficient relating discharge concentrations cQ and storage
concentration cS as cQ = alpha x cS. Alpha can be specified as a 2D q x s array if
it is assumed to be constant, or as a n x q x s array if it is to vary in time.</dd>
<dt>k1 <span class="classifier-delimiter">:</span> <span class="classifier">s x 1 or n x s float64 ndarray (default none)</span></dt>
<dd>Optional first order reaction rate. May be specified as n x s if allowed to vary in time, or s x 1 if constant.</dd>
<dt>C_eq <span class="classifier-delimiter">:</span> <span class="classifier">s x 1 or n x s float64 ndarray (default none)</span></dt>
<dd>Optional equilibrium concentration for first-order reaction rate. Assumed to be 0 if omitted.</dd>
</dl>
</dd>
<dt>Returns:</dt>
<dd><dl class="first last docutils">
<dt>A dict with the following keys:</dt>
<dd><dl class="first last docutils">
<dt>&#8216;ST&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">m+1 x n+1 numpy float64 2D array</span></dt>
<dd>Array of age-ranked storage for n times, m ages. (full_outputs=True only)</dd>
<dt>&#8216;PQ&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">m+1 x n+1 x q numpy float64 2D array</span></dt>
<dd>List of time-varying cumulative transit time distributions for n times,
m ages, and q fluxes. (full_outputs=True only)</dd>
<dt>&#8216;WaterBalance&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">m x n numpy float64 2D array</span></dt>
<dd>Should always be within tolerances of zero, unless something is very
wrong. (full_outputs=True only)</dd>
<dt>&#8216;C_Q&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">n x q x s float64 ndarray</span></dt>
<dd>If C_J is supplied, C_Q is the timeseries of outflow concentration</dd>
<dt>&#8216;MS&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">m+1 x n+1 x s float64 ndarray</span></dt>
<dd>Array of age-ranked solute mass for n times, m ages, and s solutes.
(full_outputs=True only)</dd>
<dt>&#8216;MQ&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">m+1 x n+1 x q x s float64 ndarray</span></dt>
<dd>Array of age-ranked solute mass flux for n times, m ages, q fluxes and s
solutes. (full_outputs=True only)</dd>
<dt>&#8216;MR&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">m+1 x n+1 x s float64 ndarray</span></dt>
<dd>Array of age-ranked solute reaction flux for n times, m ages, and s
solutes. (full_outputs=True only)</dd>
<dt>&#8216;SoluteBalance&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">m x n x s float64 ndarray</span></dt>
<dd>Should always be within tolerances of zero, unless something is very
wrong. (full_outputs=True only)</dd>
</dl>
</dd>
</dl>
</dd>
</dl>
<p>For each of the arrays in the full outputs each row represents an age, and each
column is a timestep. For n timesteps and m ages, ST will have dimensions
(n+1) x (m+1), with the first row representing age T = 0 and the first
column derived from the initial condition.</p>
</dd></dl>

<dl class="function">
<dt id="rsas.create_function">
<code class="descclassname">rsas.</code><code class="descname">create_function</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#rsas.create_function" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize an rSAS function</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><dl class="first last docutils">
<dt>rSAS_type <span class="classifier-delimiter">:</span> <span class="classifier">str</span></dt>
<dd>A string indicating the requested rSAS functional form.</dd>
<dt>params <span class="classifier-delimiter">:</span> <span class="classifier">n x k float64 ndarray</span></dt>
<dd>Parameters for the rSAS function. The number of columns and
their meaning depends on which rSAS type is chosen. For all the rSAS
functions implemented so far, each row corresponds with a timestep.</dd>
</dl>
</dd>
<dt>Returns:</dt>
<dd><dl class="first last docutils">
<dt>rSAS_fun <span class="classifier-delimiter">:</span> <span class="classifier">rSASFunctionClass</span></dt>
<dd>An rSAS function of the chosen type</dd>
</dl>
</dd>
</dl>
<p>The created function object will have methods that vary between types. All
must have a constructor (&#8220;__init__&#8221;) and two methods cdf_all and cdf_i. See
the documentation for rSASFunctionClass for more information.</p>
<p>Available choices for rSAS_type, and a description of parameter array, are below.
These all take one parameter set (row) per timestep:</p>
<dl class="docutils">
<dt>&#8216;uniform&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">Uniform distribution over the range [a, b].</span></dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">0]</span></code> = ST_min</li>
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">1]</span></code> = ST_max</li>
</ul>
</dd>
<dt>&#8216;kumaraswami&#8217;: Kumaraswami distribution</dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">0]</span></code> = ST_min parameter</li>
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">1]</span></code> = ST_max parameter</li>
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">2]</span></code> = a parameter</li>
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">3]</span></code> = b parameter</li>
</ul>
</dd>
<dt>&#8216;gamma&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">Gamma distribution, truncated at a maximum value (can be inf)</span></dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">0]</span></code> = ST_min parameter</li>
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">1]</span></code> = ST_max parameter (set as inf if undefined)</li>
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">2]</span></code> = scale parameter</li>
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">3]</span></code> = shape parameter</li>
</ul>
</dd>
<dt>&#8216;lookuptable&#8217; <span class="classifier-delimiter">:</span> <span class="classifier">Lookup table of values. First value of Omega must be 0 and last must be 1.</span></dt>
<dd><ul class="first last simple">
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">0]</span></code> = S_T</li>
<li><code class="docutils literal"><span class="pre">Q_params[:,</span> <span class="pre">1]</span></code> = Omega(S_T)</li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="function">
<dt id="rsas.transport">
<code class="descclassname">rsas.</code><code class="descname">transport</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#rsas.transport" title="Permalink to this definition">¶</a></dt>
<dd><p>Apply a time-varying transit time distribution to an input concentration timseries</p>
<dl class="docutils">
<dt>Args:</dt>
<dd><dl class="first last docutils">
<dt>PQ <span class="classifier-delimiter">:</span> <span class="classifier">numpy float64 2D array, size N x N</span></dt>
<dd>The CDF of the backwards transit time distribution P_Q1(T,t)</dd>
<dt>C_in <span class="classifier-delimiter">:</span> <span class="classifier">numpy float64 1D array, length N.</span></dt>
<dd>Timestep-averaged inflow concentration.</dd>
<dt>C_old <span class="classifier-delimiter">:</span> <span class="classifier">numpy float64 1D array, length N.</span></dt>
<dd>Concentration to be assumed for portion of outflows older than initial
timestep</dd>
</dl>
</dd>
<dt>Returns:</dt>
<dd><dl class="first last docutils">
<dt>C_out <span class="classifier-delimiter">:</span> <span class="classifier">numpy float64 1D array, length N.</span></dt>
<dd>Timestep-averaged outflow concentration.</dd>
<dt>C_mod_raw <span class="classifier-delimiter">:</span> <span class="classifier">numpy float64 1D array, length N.</span></dt>
<dd>Timestep-averaged outflow concentration, prior to correction with C_old.</dd>
<dt>observed_fraction <span class="classifier-delimiter">:</span> <span class="classifier">numpy float64 1D array, length N.</span></dt>
<dd>Fraction of outflow older than the first timestep</dd>
</dl>
</dd>
</dl>
</dd></dl>

<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
</div>
</div>
<div class="section" id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><span>Index</span></a></li>
<li><a class="reference internal" href="py-modindex.html"><span>Module Index</span></a></li>
<li><a class="reference internal" href="search.html"><span>Search Page</span></a></li>
</ul>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Documentation of the rsas library</a></li>
<li><a class="reference internal" href="#getting-started">Getting started</a><ul>
<li><a class="reference internal" href="#before-you-install">Before you install</a></li>
<li><a class="reference internal" href="#getting-rsas">Getting rsas</a></li>
<li><a class="reference internal" href="#installation">Installation</a></li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#steady-py">steady.py</a></li>
<li><a class="reference internal" href="#steady2-py">steady2.py</a></li>
<li><a class="reference internal" href="#unsteady-py">unsteady.py</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#further-reading">Further reading</a><ul>
<li><a class="reference internal" href="#module-rsas">Documentation for the code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>

  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/index.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="#">rsas 0.1.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, Ciaran J. Harman.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>